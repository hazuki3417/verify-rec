# Modal コンポーネント実装方針ドキュメント

## 1. 概要

本ドキュメントでは、UI コンポーネントとしての **Modal（モーダル）** を実装する際の設計方針を定義する。  
目的は、機能要件・VRT（Visual Regression Test）安定性・責務分離・拡張性のバランスを取った実装を行うことである。

---

## 2. 実装方針の全体像

### ✅ 目的
- Modal の UI 構造と振る舞い（アニメーション、Portal 管理、Overlay 制御）を **段階的に分離** し、責務を明確化する。
- **VRT（ビジュアルリグレッションテスト）を安定させる** ために、テスト環境と本番環境で描画構造を制御可能にする。
- 拡張（アニメーションやフォーカス制御）を導入しても API 破壊が起きないようにする。

---

## 3. コンポーネント構成

Modal は次の 3 層に分けて設計する。

| 層 | コンポーネント名 | 主な責務 |
|----|------------------|-----------|
| **Surface 層** | `ModalSurface` | UI 構造・見た目の描画（VRT 対象） |
| **Transition 層** | `ModalTransitionWrapper` | アニメーション・開閉状態制御 |
| **Integration 層** | `ModalRoot` | Portal / Overlay 統合、イベント制御、アプリ統合 |

---

## 4. 設計意図（Why）

### 4.1 表示制御と存在制御を分離する
通常、モーダルには「表示・非表示（UI 状態）」と「マウント・アンマウント（DOM 存在）」の 2 つの軸がある。  
アニメーションがない場合は両者を一致させてよいが、**アニメーションを導入すると「非表示中も DOM を残す」必要がある**。  
そのため、`open` props を導入する起点は **アニメーションが必要になったとき** である。

> **設計判断基準**  
> - アニメーションなし → 親側で `isShow && <ModalSurface />`（アンマウント制御）  
> - アニメーションあり → `open` props を持たせ、内部で状態を保持（表示制御）

---

### 4.2 Overlay・Portal を Modal から分離する
VRT を安定させるため、テスト環境では Portal や Overlay を含めない構造にする。  
Portal 配下にある要素は Storybook の DOM 階層が変わり、スクリーンショット差分が出やすいためである。  
そのため、**本番では Portal 統合、VRT では Surface 単体レンダリング** という二段構成を採用する。

> **設計意図**  
> - VRT での差分は「見た目の構造」だけを対象にしたい。  
> - Overlay や半透明レイヤはピクセル差分を生みやすいため除外。  
> - 責務を明確化し、Portal やアニメーションの影響を UI 層から切り離す。

---

### 4.3 stopPropagation を不要にする DOM 構造
Overlay クリックでモーダルを閉じる設計の場合でも、  
`stopPropagation()` を使うのはあくまで「親子構造時の副作用回避」である。  

以下のように兄弟構造にすることで、イベント伝搬自体を発生させず、**stopPropagation を不要化** する。

```tsx
<>
  <Overlay onClick={onClose} />
  <ModalSurface>...</ModalSurface>
</>
